### 背景
* node直接从harmony读取ip或数据


### 目标
* 输出ip+port
* 输出接口数据


### 接入

```

npm i -S @wac/js-harmony


```

```

const Harmony = require('@wac/js-harmony')

this.harmony = new Harmony({ env: 'production', unit: 'default' })

```
* 输入

|    name    | type     | value         |  remark | 
| :-------- |:------    | :------     | :------  | 
| env  | string | 'production' |  环境，挖财已有的环境包括：test, production, staging | 
| unit  | string | 'default' |  unit:  表示单元，通过环境变量APP_IDC获取，挖财已有的单元包括：hzxs,hzxs3,hzqsh,hzifc，如果没有配置环境变量可以写default,harmony会返回同机房的 | 

* 输出

|    name    | type     | value         | remark | 
| :-------- |:------    | :------     |:------     |
| harmony  | class | harmony实例 | harmony实例 |



### 使用

#### 获取ip+port 


```

const ip = await harmony.getServer('jasmineserver.wacai.info')


```

* 输入

|    name    | type     | value         | remark | 
| :-------- |:------    | :------     |:------     |
| domain  | string | 'jasmineserver.wacai.info' | 服务端接口对应的domain |

* 输出

```
{
	host: "172.16.49.173", 
	port: 8080, 
	weight: 10
}
```

#### 获取data
	

```

  const data = await harmony.getData({
    url: 'http://jasmineserver.wacai.info/jasmine/getConfig',
    qs: {
      module: 'jasmine_demo',
      subModule: 'quick_start',
      key: 'test'
    }
  })
  
```

* 输入（参照request格式）

|    name    | type     | value         | remark | 
| :-------- |:------    | :------     |:------     |
| url  | string | 'http://jasmineserver.wacai.info/jasmine/getConfig' | 服务端接口 |
| qs  | {} | {module: 'jasmine_demo',subModule: 'quick_start',key: 'test'} | 接口需要的请求参数 |

* 输出

```
  {
    "code":0,
    "data":{
        "value":"hello jasmine",
        "version":3066
    }
  }
```


### 技术实现


* 流程图
	* 轮询获取harmony-serverIPList，间隔5分钟

	![image](http://git.caimi-inc.com/client/leap-doc/uploads/46c3b1de8e50feada90ee6bab8272128/image.png)

	* 轮询获取harmony-jasmineIPList，间隔30秒
	
	![image](http://git.caimi-inc.com/client/leap-doc/uploads/47919427bc5a5cf84e6573bb37fd74f9/image.png)



#### api接口
[文档](http://git.caimi-inc.com/wac-base/jasmine/wikis/http-api)

#### init
* params
	* unit: 表示单元，通过环境变量APP_IDC获取，挖财已有的单元包括：hzxs,hzxs3,hzqsh,hzifc，如果没有配置环境变量可以写default,harmony会返回同机房的jasmine服务器地址
	* env: 表示环境，通过环境变量APP_ENV获取，挖财已有的环境包括：test, production, staging

* 启动
	* 开始轮询 


#### harmony


* ServerIPList
	* setTimeout轮询，间隔5分钟
	* 请求地址：http://api.cell.wacai.info/harmony/getServerList
		* [步骤1](http://git.caimi-inc.com/wac-base/jasmine/wikis/http-api)
		* 返回data存在内存中，harmonyServerList
		

* JasmineIPList
	* setTimeout轮询，间隔30秒
	* 请求地址：http://172.16.74.37:8080/harmony/v1/api/filterRealNodes
		* ip、port从内存harmonyServerList获取
		* [步骤2](http://git.caimi-inc.com/wac-base/jasmine/wikis/http-api)
		* 返回data存在内存中，jasmineServerList


### 单测

![image](http://git.caimi-inc.com/client/kuaidai-loan/uploads/62b565ddcb80bc57723179e33c3417c8/image.png)


### 相关人员
* 开发：天星